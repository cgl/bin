;;; .emacs-v2 --- Emacs configuration for macOS Monterey
;;; Commentary:
;;; This configuration is optimized for macOS Monterey with Python development support
;;; Code:

;; ============================================================================
;; MACOS KEY BINDINGS
;; ============================================================================
;; Monterey compatible keybindings
(setq mac-option-key-is-meta nil)
(setq mac-command-key-is-meta t)
(setq mac-command-modifier 'meta)
(setq mac-option-modifier nil)
(setq ns-function-modifier 'super)
;; Reference: https://stackoverflow.com/a/8989982/1257959

;; ============================================================================
;; PACKAGE INITIALIZATION
;; ============================================================================
(require 'package)
(setq package-archives '(("melpa" . "https://melpa.org/packages/")
                         ("melpa-stable" . "https://stable.melpa.org/packages/")
                         ("gnu" . "https://elpa.gnu.org/packages/")))

(package-initialize)

;; Ensure use-package is installed
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

(require 'use-package)
(setq use-package-always-ensure t)

;; ============================================================================
;; PACKAGE INSTALLATION
;; ============================================================================
(defvar my-packages
  '(exec-path-from-shell
    rjsx-mode
    elpy
    flycheck
    py-isort
    material-theme))

(dolist (package my-packages)
  (unless (package-installed-p package)
    (package-install package)))

;; ============================================================================
;; ENVIRONMENT SETUP
;; ============================================================================
;; Initialize PATH from shell for Monterey
(when (memq window-system '(mac ns x))
  (exec-path-from-shell-initialize)
  (exec-path-from-shell-copy-envs '("PATH" "PYENV_ROOT" "WORKON_HOME")))

;; TeX support for Monterey
(setenv "PATH" "/usr/local/bin:/Library/TeX/texbin:$PATH" t)
(setq exec-path (append exec-path '("/Library/TeX/texbin")))

;; ============================================================================
;; BASIC CUSTOMIZATION
;; ============================================================================
(global-linum-mode t)  ; Enable line numbers globally
(put 'upcase-region 'disabled nil)
(put 'downcase-region 'disabled nil)

;; ============================================================================
;; HOOKS
;; ============================================================================
;; Clean up trailing whitespace before saving
(add-hook 'before-save-hook 'delete-trailing-whitespace)

;; ============================================================================
;; PYTHON ENVIRONMENT SETUP
;; ============================================================================
;; Use pyenv shim for Python
(setq python-python-command "python3")
(setq elpy-rpc-python-command "python3")

;; Virtual environment setup
(setenv "WORKON_HOME" "/Users/cagil/work/virts/")

;; ============================================================================
;; ELPY CONFIGURATION
;; ============================================================================
;; Enable Elpy for Python development
(elpy-enable)

;; Use Flycheck instead of Flymake
(when (require 'flycheck nil t)
  (setq elpy-modules (delq 'elpy-module-flymake elpy-modules))
  (add-hook 'elpy-mode-hook 'flycheck-mode))

;; ============================================================================
;; ISORT CONFIGURATION
;; ============================================================================
;; Auto-format imports on save
(require 'py-isort)
(add-hook 'before-save-hook 'py-isort-before-save)
(setq py-isort-options '("--lines=100"))

;; ============================================================================
;; BACKUP AND AUTO-SAVE CONFIGURATION
;; ============================================================================
;; Store backups and auto-saves in temp directory
(setq backup-directory-alist
      `((".*" . ,temporary-file-directory)))
(setq auto-save-file-name-transforms
      `((".*" ,temporary-file-directory t)))

;; Clean up old backup files (older than 1 week)
(message "Deleting old backup files...")
(let ((week (* 60 60 24 7))
      (current (float-time (current-time))))
  (dolist (file (directory-files temporary-file-directory t))
    (when (and (backup-file-name-p file)
               (> (- current (float-time (nth 5 (file-attributes file))))
                  week))
      (message "Deleting backup: %s" file)
      (delete-file file))))

;; ============================================================================
;; CUSTOM SETTINGS (Auto-generated)
;; ============================================================================
(custom-set-variables
 '(elpy-rpc-python-command "python3")
 '(package-selected-packages
   '(exec-path-from-shell use-package rjsx-mode flycheck py-isort material-theme)))

(custom-set-faces)

;; ============================================================================
;; END OF CONFIGURATION
;; ============================================================================
(provide '.emacs-v2)
;;; .emacs-v2 ends here